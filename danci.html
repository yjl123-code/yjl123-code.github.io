<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词大作战</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 添加SheetJS库用于处理Excel文件 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        secondary: '#EC4899',
                        accent: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444',
                        light: '#F9FAFB',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        comic: ['Comic Sans MS', 'cursive', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            }
            .word-box {
                transition: all 0.3s ease;
                cursor: pointer;
            }
            .word-box:hover {
                transform: scale(1.05);
            }
            .correct-scale {
                animation: correctScale 0.3s ease-in-out forwards;
            }
            .wrong-shake {
                animation: wrongShake 0.5s ease-in-out;
            }
            .confetti {
                position: absolute;
                width: 10px;
                height: 10px;
                opacity: 0;
                animation: confetti-fall 1s ease-in-out forwards;
            }
            .countdown-animation {
                animation: countdownPulse 1s ease-in-out infinite;
            }
            .time-warning {
                animation: timeWarning 1s ease-in-out infinite alternate;
            }
            .bounce-in {
                animation: bounceIn 0.6s ease-out forwards;
            }
            .file-drop-active {
                border-color: #6366F1;
                background-color: rgba(99, 102, 241, 0.1);
            }
            .target-word {
                border: 2px solid #F59E0B;
                box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            }
        }
        
        @keyframes correctScale {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(0); }
        }
        
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes countdownPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        @keyframes timeWarning {
            from { color: #EF4444; }
            to { color: #ff8888; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .countdown-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .countdown-number {
            font-size: 8rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.8);
        }
        
        .game-time-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .game-time-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .timer-display {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
        }
        
        /* 封面页样式 */
        .cover-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
            overflow-y: auto;
            padding: 2rem 0;
        }
        
        .word-list-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 1rem;
            padding: 2rem;
            margin: 1rem 0;
            max-width: 90%;
            max-height: 50vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .word-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.8rem 1.5rem;
        }
        
        .word-pair {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
            align-items: center;
        }
        
        .word-pair i {
            margin-right: 8px;
            color: #6366F1;
        }
        
        .enter-game-btn {
            margin-top: 1.5rem;
            background-color: #F59E0B;
            color: white;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            display: flex;
            align-items: center;
        }
        
        .enter-game-btn i {
            margin-right: 10px;
        }
        
        .enter-game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }
        
        /* 文件上传区域样式 */
        .file-upload-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 1rem;
            padding: 2rem;
            margin: 1rem 0;
            max-width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .file-drop-area {
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            padding: 2rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-icon {
            font-size: 3rem;
            color: #6366F1;
            margin-bottom: 1rem;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            color: #666;
            font-size: 0.9rem;
            margin-top: 1rem;
        }
        
        .upload-btn {
            background-color: #6366F1;
            color: white;
            border: none;
            padding: 0.7rem 2rem;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }
        
        .upload-btn:hover {
            background-color: #5254f1;
        }
        
        .upload-success {
            color: #10B981;
            margin-top: 1rem;
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-indigo-50 to-purple-100 min-h-screen font-comic overflow-x-hidden">
    <!-- 封面页 -->
    <div id="cover-page" class="cover-page">
        <h1 class="text-[clamp(2.5rem,8vw,4rem)] font-bold text-white text-shadow text-center mb-4 bounce-in">
            单词大作战
        </h1>
        <p class="text-white/90 text-lg mb-6">挑战你的词汇量，在30秒内尽可能多地匹配正确单词！</p>
        
        <!-- 文件上传区域 -->
        <div class="file-upload-container bounce-in" style="animation-delay: 0.1s">
            <h2 class="text-center font-bold text-primary mb-3">上传单词表</h2>
            <div id="file-drop-area" class="file-drop-area">
                <div class="file-icon">
                    <i class="fa fa-file-excel-o"></i>
                </div>
                <p class="mb-2">拖放Excel文件到此处，或点击选择文件</p>
                <p class="text-sm text-gray-500">支持 .xlsx 格式，第一列英文，第二列中文</p>
                <input type="file" id="file-input" class="file-input" accept=".xlsx, .xls">
                <button id="browse-btn" class="upload-btn">选择文件</button>
                <div id="upload-success" class="upload-success">
                    <i class="fa fa-check-circle"></i> 单词表上传成功！
                </div>
            </div>
            <div class="file-info">
                提示：Excel表格应包含两列，第一列为英文单词，第二列为对应中文意思
            </div>
        </div>
        
        <div class="word-list-container bounce-in" style="animation-delay: 0.2s">
            <h2 class="text-center font-bold text-primary mb-3">单词表预览</h2>
            <div class="word-list" id="cover-word-list">
                <!-- 单词列表将通过JS动态生成 -->
            </div>
        </div>
        
        <button id="enter-game-btn" class="enter-game-btn bounce-in" style="animation-delay: 0.4s">
            <i class="fa fa-gamepad"></i> 进入游戏
        </button>
    </div>
    
    <!-- 开始倒计时覆盖层 -->
    <div id="countdown-overlay" class="countdown-overlay">
        <div id="countdown-number" class="countdown-number countdown-animation">3</div>
    </div>
    
    <!-- 游戏时间结束覆盖层 -->
    <div id="time-overlay" class="game-time-overlay">
        <h2 class="text-4xl font-bold text-white mb-4">时间到！</h2>
        <p class="text-2xl text-white mb-6">你的最终得分是：<span id="final-score" class="text-accent">0</span>分</p>
        <button id="overlay-restart" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg">
            再玩一次
        </button>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 游戏标题 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-primary text-shadow mb-2">
                <i class="fa fa-star text-accent animate-pulse"></i> 单词大作战 <i class="fa fa-star text-accent animate-pulse"></i>
            </h1>
            <p class="text-dark/70 text-lg">匹配正确的英文单词，挑战你的词汇量！</p>
        </header>
        
        <!-- 游戏控制按钮和计时器 -->
        <div class="flex flex-wrap justify-center gap-4 mb-8 items-center">
            <button id="start-btn" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg flex items-center">
                <i class="fa fa-play mr-2"></i> 开始挑战
            </button>
            <button id="restart-btn" class="bg-accent hover:bg-accent/90 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg flex items-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa fa-refresh mr-2"></i> 重新开始
            </button>
            <button id="score-btn" class="bg-secondary hover:bg-secondary/90 text-white font-bold py-3 px-8 rounded-full transition-all duration-300 shadow-lg flex items-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa fa-trophy mr-2"></i> 计算得分
            </button>
            
            <!-- 游戏计时器 -->
            <div class="ml-4 bg-white/80 backdrop-blur-sm px-6 py-3 rounded-full shadow-md flex items-center">
                <i class="fa fa-clock-o text-danger mr-2"></i>
                <span class="text-dark/70 mr-1">剩余时间：</span>
                <span id="game-timer" class="text-2xl font-bold text-primary">30</span>
                <span class="text-dark/70 ml-1">秒</span>
            </div>
        </div>
        
        <!-- 分数显示 -->
        <div class="text-center mb-6">
            <div class="inline-block bg-white/80 backdrop-blur-sm px-6 py-2 rounded-full shadow-md">
                <span class="text-dark/70 mr-2">当前得分：</span>
                <span id="score-display" class="text-2xl font-bold text-primary">0</span>
                <span class="text-dark/70 ml-1">分</span>
            </div>
        </div>
        
        <!-- 中文提示区域 -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8 text-center">
            <h2 class="text-xl text-dark/70 mb-3">请点击与下面中文意思匹配的英文单词</h2>
            <div id="chinese-hint" class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-primary min-h-[80px] flex items-center justify-center">
                准备开始挑战
            </div>
        </div>
        
        <!-- 游戏主区域 -->
        <div id="game-area" class="relative bg-white/60 backdrop-blur-sm rounded-2xl shadow-xl min-h-[400px] mb-8 overflow-hidden">
            <!-- 单词将通过JavaScript动态生成并添加到这里 -->
            <div class="absolute inset-0 flex items-center justify-center text-gray-400" id="game-placeholder">
                <p>点击"开始挑战"按钮开始游戏</p>
            </div>
        </div>
        
        <!-- 游戏说明 -->
        <div class="bg-white/80 backdrop-blur-sm rounded-xl p-5 shadow-md">
            <h3 class="font-bold text-center mb-3 text-primary">游戏说明</h3>
            <ul class="list-disc list-inside text-dark/70 space-y-2">
                <li>点击"开始挑战"后，会有3秒倒计时，随后单词从上方持续掉落</li>
                <li>你有30秒时间找到与顶部中文意思匹配的英文单词并点击它</li>
                <li>正确匹配：单词放大后消失，加10分，并有烟花效果</li>
                <li>错误匹配：单词会晃动提示错误，继续下落</li>
                <li>30秒倒计时结束后，游戏结束并显示最终得分</li>
            </ul>
        </div>
    </div>
    
    <!-- 音效元素 -->
    <audio id="correct-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="wrong-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <audio id="countdown-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-digital-clock-digital-alarm-bell-989.mp3" type="audio/mpeg">
    </audio>
    <audio id="time-up-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>
    <audio id="start-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-game-start-2574.mp3" type="audio/mpeg">
    </audio>
    <audio id="upload-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" type="audio/mpeg">
    </audio>
    
    <script>
        // 单词库 - 英文和对应的中文意思
        let wordLibrary = [
            { english: "apple", chinese: "苹果", icon: "fa-apple" },
            { english: "banana", chinese: "香蕉", icon: "fa-lemon-o" },
            { english: "cat", chinese: "猫", icon: "fa-paw" },
            { english: "dog", chinese: "狗", icon: "fa-paw" },
            { english: "sun", chinese: "太阳", icon: "fa-sun-o" },
            { english: "moon", chinese: "月亮", icon: "fa-moon-o" },
            { english: "book", chinese: "书", icon: "fa-book" },
            { english: "pen", chinese: "钢笔", icon: "fa-pencil" },
            { english: "red", chinese: "红色", icon: "fa-square" },
            { english: "blue", chinese: "蓝色", icon: "fa-square" },
            { english: "one", chinese: "一", icon: "fa-hashtag" },
            { english: "two", chinese: "二", icon: "fa-hashtag" },
            { english: "run", chinese: "跑", icon: "fa-bolt" },
            { english: "jump", chinese: "跳", icon: "fa-arrows-v" },
            { english: "water", chinese: "水", icon: "fa-tint" },
            { english: "fire", chinese: "火", icon: "fa-fire" },
            { english: "happy", chinese: "开心", icon: "fa-smile-o" },
            { english: "sad", chinese: "难过", icon: "fa-frown-o" },
            { english: "big", chinese: "大的", icon: "fa-expand" },
            { english: "small", chinese: "小的", icon: "fa-compress" }
        ];
        
        // 游戏状态
        const gameState = {
            isPlaying: false,
            score: 0,
            currentWordSet: [],
            currentTarget: null,
            fallingWords: [],
            animationIds: [],
            isCountingDown: false,
            gameTime: 30, // 游戏时间30秒
            timerInterval: null,
            spawnInterval: null, // 用于控制单词生成的间隔
            consecutiveMisses: 0 // 连续未命中计数
        };
        
        // DOM 元素
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const scoreBtn = document.getElementById('score-btn');
        const scoreDisplay = document.getElementById('score-display');
        const chineseHint = document.getElementById('chinese-hint');
        const gameArea = document.getElementById('game-area');
        const gamePlaceholder = document.getElementById('game-placeholder');
        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownNumber = document.getElementById('countdown-number');
        const countdownSound = document.getElementById('countdown-sound');
        const gameTimer = document.getElementById('game-timer');
        const timeOverlay = document.getElementById('time-overlay');
        const finalScore = document.getElementById('final-score');
        const overlayRestart = document.getElementById('overlay-restart');
        const timeUpSound = document.getElementById('time-up-sound');
        const startSound = document.getElementById('start-sound');
        const coverPage = document.getElementById('cover-page');
        const enterGameBtn = document.getElementById('enter-game-btn');
        const coverWordList = document.getElementById('cover-word-list');
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const uploadSuccess = document.getElementById('upload-success');
        const uploadSound = document.getElementById('upload-sound');
        
        // 初始化封面页单词列表
        function initCoverWordList() {
            // 清空现有列表
            coverWordList.innerHTML = '';
            
            wordLibrary.forEach(word => {
                const wordPair = document.createElement('div');
                wordPair.className = 'word-pair';
                wordPair.innerHTML = `<span class="text-primary font-medium"><i class="fa ${word.icon}"></i> ${word.english}</span> <span class="text-dark/70">${word.chinese}</span>`;
                coverWordList.appendChild(wordPair);
            });
        }
        
        // 处理文件上传
        function handleFileUpload(file) {
            // 检查文件类型
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension !== 'xlsx' && fileExtension !== 'xls') {
                alert('请上传Excel文件（.xlsx 或 .xls 格式）');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // 验证数据格式
                    if (jsonData.length < 1) {
                        alert('Excel文件中没有数据');
                        return;
                    }
                    
                    // 处理数据 - 跳过表头行
                    const newWordLibrary = [];
                    let hasHeader = false;
                    
                    // 检查第一行是否为表头
                    if (typeof jsonData[0][0] === 'string' && 
                        (jsonData[0][0].toLowerCase().includes('英文') || 
                         jsonData[0][0].toLowerCase().includes('english'))) {
                        hasHeader = true;
                    }
                    
                    // 从数据行开始处理
                    const startRow = hasHeader ? 1 : 0;
                    
                    for (let i = startRow; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row.length >= 2 && row[0] && row[1]) {
                            // 为每个单词自动分配一个图标
                            const icons = ['fa-apple', 'fa-lemon-o', 'fa-paw', 'fa-sun-o', 'fa-moon-o', 
                                          'fa-book', 'fa-pencil', 'fa-square', 'fa-hashtag', 'fa-bolt',
                                          'fa-arrows-v', 'fa-tint', 'fa-fire', 'fa-smile-o', 'fa-frown-o',
                                          'fa-expand', 'fa-compress'];
                            const randomIcon = icons[Math.floor(Math.random() * icons.length)];
                            
                            newWordLibrary.push({
                                english: String(row[0]).trim(),
                                chinese: String(row[1]).trim(),
                                icon: randomIcon
                            });
                        }
                    }
                    
                    if (newWordLibrary.length === 0) {
                        alert('未能从Excel文件中读取有效的单词数据，请确保文件格式正确');
                        return;
                    }
                    
                    // 更新单词库
                    wordLibrary = newWordLibrary;
                    
                    // 更新单词列表显示
                    initCoverWordList();
                    
                    // 显示上传成功消息
                    uploadSuccess.style.display = 'block';
                    uploadSuccess.innerHTML = `<i class="fa fa-check-circle"></i> 单词表上传成功！共导入 ${wordLibrary.length} 个单词`;
                    
                    // 播放上传成功音效
                    uploadSound.currentTime = 0;
                    uploadSound.play();
                    
                    // 3秒后隐藏成功消息
                    setTimeout(() => {
                        uploadSuccess.style.display = 'none';
                    }, 3000);
                    
                } catch (error) {
                    console.error('处理Excel文件时出错:', error);
                    alert('处理文件时出错，请确保文件格式正确');
                }
            };
            
            reader.onerror = function() {
                alert('读取文件时出错');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 事件监听 - 文件上传相关
        browseBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                handleFileUpload(e.target.files[0]);
            }
        });
        
        // 拖放功能
        fileDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropArea.classList.add('file-drop-active');
        });
        
        fileDropArea.addEventListener('dragleave', () => {
            fileDropArea.classList.remove('file-drop-active');
        });
        
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.classList.remove('file-drop-active');
            
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });
        
        // 其他事件监听
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', restartGame);
        scoreBtn.addEventListener('click', showScore);
        overlayRestart.addEventListener('click', restartGame);
        enterGameBtn.addEventListener('click', enterGame);
        
        // 进入游戏（从封面页到游戏页）
        function enterGame() {
            startSound.currentTime = 0;
            startSound.play();
            
            coverPage.style.opacity = '0';
            setTimeout(() => {
                coverPage.style.display = 'none';
            }, 500);
        }
        
        // 开始游戏
        function startGame() {
            // 防止重复点击
            if (gameState.isPlaying || gameState.isCountingDown) return;
            
            // 更新UI状态
            startBtn.disabled = true;
            restartBtn.disabled = true;
            scoreBtn.disabled = true;
            gamePlaceholder.classList.add('hidden');
            gameState.isCountingDown = true;
            gameState.consecutiveMisses = 0; // 重置连续未命中计数
            
            // 显示开始倒计时
            showCountdown(() => {
                // 倒计时结束后开始游戏
                gameState.isCountingDown = false;
                gameState.isPlaying = true;
                restartBtn.disabled = false;
                
                // 初始化第一个目标
                setNewTarget();
                
                // 开始持续生成掉落的单词
                startSpawningWords();
                
                // 开始游戏计时器
                startGameTimer();
            });
        }
        
        // 显示开始倒计时
        function showCountdown(callback) {
            let count = 3;
            
            // 显示倒计时覆盖层
            countdownOverlay.classList.add('active');
            countdownNumber.textContent = count;
            
            // 播放倒计时音效
            countdownSound.currentTime = 0;
            countdownSound.play();
            
            const countdownInterval = setInterval(() => {
                count--;
                
                if (count > 0) {
                    countdownNumber.textContent = count;
                    // 播放倒计时音效
                    countdownSound.currentTime = 0;
                    countdownSound.play();
                } else {
                    // 倒计时结束
                    clearInterval(countdownInterval);
                    countdownNumber.textContent = "开始!";
                    
                    // 播放开始音效
                    countdownSound.currentTime = 0;
                    countdownSound.play();
                    
                    setTimeout(() => {
                        // 隐藏倒计时覆盖层
                        countdownOverlay.classList.remove('active');
                        // 执行回调函数，开始游戏
                        callback();
                    }, 500);
                }
            }, 1000);
        }
        
        // 开始游戏计时器
        function startGameTimer() {
            // 重置计时器显示
            gameState.gameTime = 30;
            gameTimer.textContent = gameState.gameTime;
            gameTimer.classList.remove('time-warning');
            
            // 清除可能存在的计时器
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
            }
            
            // 设置新计时器
            gameState.timerInterval = setInterval(() => {
                gameState.gameTime--;
                gameTimer.textContent = gameState.gameTime;
                
                // 时间少于10秒时添加警告效果
                if (gameState.gameTime <= 10) {
                    gameTimer.classList.add('time-warning');
                    
                    // 最后5秒添加音效提示
                    if (gameState.gameTime <= 5 && gameState.gameTime > 0) {
                        countdownSound.currentTime = 0;
                        countdownSound.play();
                    }
                }
                
                // 时间到，结束游戏
                if (gameState.gameTime <= 0) {
                    endGame();
                }
            }, 1000);
        }
        
        // 开始持续生成单词
        function startSpawningWords() {
            // 立即生成第一个单词
            createTargetedFallingWord();
            
            // 设置间隔生成单词
            gameState.spawnInterval = setInterval(() => {
                if (gameState.isPlaying) {
                    createTargetedFallingWord();
                }
            }, 100 + Math.random() * 300);
        }
        
        // 创建与当前目标相关的掉落单词，提高目标单词出现概率
        function createTargetedFallingWord() {
            // 找到与当前目标匹配的单词
            const matchingWords = wordLibrary.filter(word => 
                word.chinese === gameState.currentTarget.chinese
            );
            
            // 非匹配单词
            const otherWords = wordLibrary.filter(word => 
                word.chinese !== gameState.currentTarget.chinese
            );
            
            // 根据连续未命中次数调整概率
            let targetProbability = 0.5; // 默认30%概率出现目标单词
            if (gameState.consecutiveMisses >= 2) {
                targetProbability = 0.7; // 2次未命中后提高到50%
            }
            if (gameState.consecutiveMisses >= 4) {
                targetProbability = 0.9; // 4次未命中后提高到70%
            }
            
            let selectedWord;
            
            // 按概率选择单词
            if (matchingWords.length > 0 && Math.random() < targetProbability) {
                // 选择匹配单词
                const randomIndex = Math.floor(Math.random() * matchingWords.length);
                selectedWord = matchingWords[randomIndex];
            } else {
                // 选择非匹配单词
                const randomIndex = Math.floor(Math.random() * otherWords.length);
                selectedWord = otherWords[randomIndex];
            }
            
            createFallingWord(selectedWord, matchingWords.includes(selectedWord));
        }
        
        // 创建掉落的单词元素
        function createFallingWord(word, isTargetWord) {
            const wordBox = document.createElement('div');
            const colors = [
                'bg-blue-100 text-blue-600 border-blue-200',
                'bg-pink-100 text-pink-600 border-pink-200',
                'bg-green-100 text-green-600 border-green-200',
                'bg-yellow-100 text-yellow-600 border-yellow-200',
                'bg-purple-100 text-purple-600 border-purple-200',
                'bg-orange-100 text-orange-600 border-orange-200'
            ];
            
            // 随机选择颜色
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            // 设置样式，如果是目标单词则添加特殊标记
            let className = `word-box absolute px-6 py-3 rounded-lg border shadow-lg ${randomColor} text-xl md:text-2xl`;
            if (isTargetWord) {
                className += ' target-word';
            }
            
            wordBox.className = className;
            wordBox.innerHTML = `<i class="fa ${word.icon} mr-2"></i>${word.english}`;
            wordBox.dataset.english = word.english;
            wordBox.dataset.chinese = word.chinese;
            
            // 随机水平位置
            const maxLeft = gameArea.clientWidth - 150;
            const randomLeft = Math.floor(Math.random() * maxLeft);
            wordBox.style.left = `${randomLeft}px`;
            wordBox.style.top = '-80px';
            
            // 添加到游戏区域
            gameArea.appendChild(wordBox);
            
            // 添加点击事件
            wordBox.addEventListener('click', () => handleWordClick(wordBox));
            
            // 记录这个单词
            gameState.fallingWords.push(wordBox);
            
            // 开始下落动画
            animateFalling(wordBox);
        }
        
        // 结束游戏
        function endGame() {
            // 清除所有计时器
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            if (gameState.spawnInterval) {
                clearInterval(gameState.spawnInterval);
                gameState.spawnInterval = null;
            }
            
            // 更新游戏状态
            gameState.isPlaying = false;
            scoreBtn.disabled = false;
            
            // 播放时间到音效
            timeUpSound.currentTime = 0;
            timeUpSound.play();
            
            // 显示最终得分
            finalScore.textContent = gameState.score;
            timeOverlay.classList.add('active');
        }
        
        // 重置游戏状态
        function resetGameState() {
            // 清除所有动画
            gameState.animationIds.forEach(id => cancelAnimationFrame(id));
            
            // 清除所有计时器
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            if (gameState.spawnInterval) {
                clearInterval(gameState.spawnInterval);
                gameState.spawnInterval = null;
            }
            
            // 隐藏时间到覆盖层
            timeOverlay.classList.remove('active');
            
            // 清空游戏区域
            while (gameArea.children.length > 1) {
                gameArea.removeChild(gameArea.lastChild);
            }
            
            // 重置游戏状态
            gameState.score = 0;
            gameState.currentWordSet = [];
            gameState.currentTarget = null;
            gameState.fallingWords = [];
            gameState.animationIds = [];
            gameState.isPlaying = false;
            gameState.isCountingDown = false;
            gameState.consecutiveMisses = 0;
            
            // 更新UI
            scoreDisplay.textContent = '0';
            gameTimer.textContent = '30';
            gameTimer.classList.remove('time-warning');
            chineseHint.textContent = '准备开始挑战';
            gamePlaceholder.classList.remove('hidden');
        }
        
        // 重新开始游戏
        function restartGame() {
            // 停止所有音效
            correctSound.pause();
            wrongSound.pause();
            countdownSound.pause();
            timeUpSound.pause();
            startSound.pause();
            uploadSound.pause();
            correctSound.currentTime = 0;
            wrongSound.currentTime = 0;
            countdownSound.currentTime = 0;
            timeUpSound.currentTime = 0;
            startSound.currentTime = 0;
            uploadSound.currentTime = 0;
            
            // 重置游戏状态并开始
            resetGameState();
            startGame();
        }
        
        // 显示得分
        function showScore() {
            alert(`游戏结束！你的最终得分是：${gameState.score}分`);
        }
        
        // 显示当前目标中文
        function displayCurrentTarget() {
            chineseHint.textContent = gameState.currentTarget.chinese;
        }
        
        // 设置新目标
        function setNewTarget() {
            // 从单词库中随机选择一个作为新目标
            const randomIndex = Math.floor(Math.random() * wordLibrary.length);
            gameState.currentTarget = wordLibrary[randomIndex];
            
            // 显示新目标
            displayCurrentTarget();
        }
        
        // 单词下落动画
        function animateFalling(element) {
            const start = performance.now();
            // 下落时间2-5秒
            const duration = 2000 + Math.random() * 3000;
            const startTop = -80;
            const endTop = gameArea.clientHeight;
            
            function animate(currentTime) {
                if (!gameState.fallingWords.includes(element) || !gameState.isPlaying) return;
                
                const elapsed = currentTime - start;
                const progress = Math.min(elapsed / duration, 1);
                const top = startTop + (endTop - startTop) * progress;
                
                element.style.top = `${top}px`;
                
                if (progress < 1) {
                    const id = requestAnimationFrame(animate);
                    // 只保留最新的动画ID
                    const index = gameState.animationIds.indexOf(id);
                    if (index === -1) {
                        gameState.animationIds.push(id);
                    }
                } else {
                    // 落到页面底部后移除
                    removeWord(element);
                    
                    // 如果掉落的是目标单词且未被点击，增加连续未命中计数
                    if (element.classList.contains('target-word')) {
                        gameState.consecutiveMisses++;
                    }
                }
            }
            
            const id = requestAnimationFrame(animate);
            gameState.animationIds.push(id);
        }
        
        // 处理单词点击
        function handleWordClick(element) {
            // 如果游戏已结束或正在倒计时，不处理点击
            if (!gameState.isPlaying || gameState.isCountingDown) return;
            
            const clickedWord = {
                english: element.dataset.english,
                chinese: element.dataset.chinese
            };
            
            // 检查是否匹配当前目标
            if (clickedWord.chinese === gameState.currentTarget.chinese) {
                // 正确匹配，重置连续未命中计数
                gameState.consecutiveMisses = 0;
                handleCorrectAnswer(element);
            } else {
                // 错误匹配，增加连续未命中计数
                gameState.consecutiveMisses++;
                handleWrongAnswer(element);
            }
        }
        
        // 处理正确答案
        function handleCorrectAnswer(element) {
            // 播放正确音效
            correctSound.currentTime = 0;
            correctSound.play();
            
            // 移除下落动画
            const index = gameState.fallingWords.indexOf(element);
            if (index !== -1) {
                gameState.fallingWords.splice(index, 1);
            }
            
            // 添加正确动画
            element.classList.add('correct-scale');
            
            // 创建烟花效果
            createConfetti(element.offsetLeft + element.offsetWidth / 2, 
                          element.offsetTop + element.offsetHeight / 2);
            
            // 增加分数
            gameState.score += 10;
            scoreDisplay.textContent = gameState.score;
            
            // 移除元素
            setTimeout(() => {
                if (element.parentNode === gameArea) {
                    gameArea.removeChild(element);
                }
                
                // 设置新目标
                setNewTarget();
            }, 300);
        }
        
        // 处理错误答案
        function handleWrongAnswer(element) {
            // 播放错误音效
            wrongSound.currentTime = 0;
            wrongSound.play();
            
            // 添加错误动画
            element.classList.add('wrong-shake');
            
            // 移除动画类，以便下次可以再次触发
            setTimeout(() => {
                element.classList.remove('wrong-shake');
            }, 500);
        }
        
        // 创建烟花效果
        function createConfetti(x, y) {
            const colors = ['#6366F1', '#EC4899', '#F59E0B', '#10B981', '#EF4444', '#8B5CF6'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${x}px`;
                confetti.style.top = `${y}px`;
                
                // 随机大小
                const size = 5 + Math.random() * 10;
                confetti.style.width = `${size}px`;
                confetti.style.height = `${size}px`;
                
                // 随机方向
                const angle = Math.random() * Math.PI * 2;
                const distance = 5 + Math.random() * 40;
                confetti.style.transform = `translate(-50%, -50%)`;
                
                // 添加到页面
                document.body.appendChild(confetti);
                
                // 动画结束后移除
                setTimeout(() => {
                    confetti.remove();
                }, 1000);
            }
        }
        
        // 移除单词
        function removeWord(element) {
            const index = gameState.fallingWords.indexOf(element);
            if (index !== -1) {
                gameState.fallingWords.splice(index, 1);
            }
            
            if (element.parentNode === gameArea) {
                gameArea.removeChild(element);
            }
        }
        
        // 初始化封面页单词列表
        initCoverWordList();
    </script>
</body>
</html>
